<section
  class="fixed inset-0 z-200 flex items-center justify-center p-4 bg-background/80 backdrop-blur-sm"
  id="fiche-form"
>

  <!-- Decorative vertical lines -->
  <div aria-hidden="true" class="fixed inset-0 pointer-events-none flex justify-evenly">
    <span class="w-px h-full bg-gradient-to-b from-transparent via-primary/20 to-transparent"></span>
    <span class="w-px h-full bg-gradient-to-b from-transparent via-primary/20 to-transparent"></span>
    <span class="w-px h-full bg-gradient-to-b from-transparent via-primary/20 to-transparent"></span>
  </div>

  <!-- Panel -->
  <div class="relative z-500 w-full max-w-xl bg-stone-50 rounded-xl shadow-2xl overflow-hidden">

    <!-- Header (ne scroll pas) -->
    <header class="relative px-8 pt-8 pb-5 shrink-0">
      <p class="text-[.68rem] tracking-[.18em] uppercase text-text-500 mb-2">Fiche Botanique</p>
      <h3 class="!m-0 !p-0 text-2xl font-semibold tracking-tight text-text">
        {{ fiche() ? "Modifier la fiche" : "Nouvelle fiche" }}
      </h3>
      <button
        class="absolute top-4 right-4 !mt-0 !mx-0 !shadow-none !bg-transparent !border-0 !p-1
               grid place-items-center w-9 h-9 rounded-full text-text-400 hover:text-text hover:bg-background-200"
        role="button"
        title="Fermer le formulaire"
        type="button"
        (click)="closeModal()"
        (keydown)="handleKey($event)"
      >
        <span class="material-symbols-outlined">close</span>
      </button>
    </header>

    <!-- Progress bar (ne scroll pas) -->
    <div class="h-[3px] bg-background-200 shrink-0">
      <div
        class="h-full bg-gradient-to-r from-primary to-primary-300 transition-[width] duration-300 ease-in-out"
        [style.width.%]="formProgress()"
      ></div>
    </div>

    <!-- Form body (scrollable) -->
    <form
      class="flex flex-col gap-5 px-8 py-7 overflow-y-auto"
      [formGroup]="form()"
      (ngSubmit)="submit()"
    >

      <!-- Description -->
      <div class="flex flex-col gap-1.5">
        <div class="flex items-baseline justify-between">
          <label
            class="flex items-baseline gap-2 text-[.68rem] tracking-[.1em] uppercase text-accent cursor-pointer"
            for="description"
          >
            <span class="bg-text text-background-50 text-[.58rem] px-1.5 py-0.5 rounded">01</span>
            Description
            <span class="text-primary text-sm leading-none">*</span>
          </label>
          <span class="text-[.62rem] text-text-400">{{ form().get('description')?.value?.length ?? 0 }}</span>
        </div>
        <div class="relative">
          <textarea
            class="w-full px-4 pr-9 py-3 text-sm leading-relaxed text-text bg-white border-[1.5px]
                   rounded-lg resize-y placeholder:text-text-300 placeholder:italic transition
                   focus:outline-none focus:ring-[3px]"
            formControlName="description"
            id="description"
            placeholder="Décrivez l'espèce avec précision…"
            rows="4"
            [class.bg-red-50]="form().get('description')?.invalid && (form().get('description')?.touched || form().dirty || submitted)"
            [class.border-background-200]="!(form().get('description')?.invalid && (form().get('description')?.touched || form().dirty || submitted))"
            [class.border-red-400]="form().get('description')?.invalid && (form().get('description')?.touched || form().dirty || submitted)"
          ></textarea>
          <span class="material-symbols-outlined absolute right-3 top-3 text-[1rem] text-text-300 pointer-events-none">article</span>
        </div>
        @if (form().get('description')?.invalid && (form().get('description')?.touched || form().dirty || submitted)) {
          <app-error [errorMessage]="'Une description est obligatoire'" />
        }
      </div>

      <!-- Usages -->
      <div class="flex flex-col gap-1.5">
        <div class="flex items-baseline justify-between">
          <label
            class="flex items-baseline gap-2 text-[.68rem] tracking-[.1em] uppercase text-accent cursor-pointer"
            for="usages"
          >
            <span class="bg-text text-background-50 text-[.58rem] px-1.5 py-0.5 rounded">02</span>
            Usages
          </label>
          <span class="text-[.62rem] text-text-400">{{ form().get('usages')?.value?.length ?? 0 }}</span>
        </div>
        <div class="relative">
          <textarea
            class="w-full px-4 pr-9 py-3 text-sm leading-relaxed text-text bg-white border-[1.5px]
                   border-background-200 rounded-lg resize-y placeholder:text-text-300 placeholder:italic
                   transition focus:outline-none focus:border-accent focus:ring-[3px] focus:ring-accent/15"
            formControlName="usages"
            id="usages"
            placeholder="Usages ethnobotaniques, médicinaux, alimentaires…"
            rows="4"
          ></textarea>
          <span class="material-symbols-outlined absolute right-3 top-3 text-[1rem] text-text-300 pointer-events-none">spa</span>
        </div>
      </div>

      <!-- Écologie -->
      <div class="flex flex-col gap-1.5">
        <div class="flex items-baseline justify-between">
          <label
            class="flex items-baseline gap-2 text-[.68rem] tracking-[.1em] uppercase text-accent cursor-pointer"
            for="ecologie"
          >
            <span class="bg-text text-background-50 text-[.58rem] px-1.5 py-0.5 rounded">03</span>
            Écologie
          </label>
          <span class="text-[.62rem] text-text-400">{{ form().get('ecologie')?.value?.length ?? 0 }}</span>
        </div>
        <div class="relative">
          <textarea
            class="w-full px-4 pr-9 py-3 text-sm leading-relaxed text-text bg-white border-[1.5px]
                   border-background-200 rounded-lg resize-y placeholder:text-text-300 placeholder:italic
                   transition focus:outline-none focus:border-accent focus:ring-[3px] focus:ring-accent/15"
            formControlName="ecologie"
            id="ecologie"
            placeholder="Habitat, substrat, altitude, associations végétales…"
            rows="4"
          ></textarea>
          <span class="material-symbols-outlined absolute right-3 top-3 text-[1rem] text-text-300 pointer-events-none">forest</span>
        </div>
      </div>

      <!-- Sources -->
      <div class="flex flex-col gap-1.5">
        <div class="flex items-baseline justify-between">
          <label
            class="flex items-baseline gap-2 text-[.68rem] tracking-[.1em] uppercase text-accent cursor-pointer"
            for="sources"
          >
            <span class="bg-text text-background-50 text-[.58rem] px-1.5 py-0.5 rounded">04</span>
            Sources
            <span class="text-primary text-sm leading-none">*</span>
          </label>
          <span class="text-[.62rem] text-text-400">{{ form().get('sources')?.value?.length ?? 0 }}</span>
        </div>
        <div class="relative">
          <textarea
            class="w-full px-4 pr-9 py-3 text-sm leading-relaxed text-text bg-white border-[1.5px]
                   rounded-lg resize-y placeholder:text-text-300 placeholder:italic transition
                   focus:outline-none focus:ring-[3px]"
            formControlName="sources"
            id="sources"
            placeholder="Références bibliographiques, auteurs, années…"
            rows="4"
            [class.bg-red-50]="form().get('sources')?.invalid && (form().get('sources')?.touched || form().dirty || submitted)"
            [class.border-background-200]="!(form().get('sources')?.invalid && (form().get('sources')?.touched || form().dirty || submitted))"
            [class.border-red-400]="form().get('sources')?.invalid && (form().get('sources')?.touched || form().dirty || submitted)"
          ></textarea>
          <span class="material-symbols-outlined absolute right-3 top-3 text-[1rem] text-text-300 pointer-events-none">menu_book</span>
        </div>
        @if (form().get('sources')?.invalid && (form().get('sources')?.touched || form().dirty || submitted)) {
          <app-error [errorMessage]="'Les sources sont obligatoires'" />
        }
      </div>

      <!-- Actions -->
      <div class="flex items-center justify-between gap-3 pt-4 border-t border-background-200">
        <button
          class="!mt-0 !mx-0 !shadow-none !bg-transparent !border !border-background-300
                 hover:!bg-background-100 hover:!border-background-400 hover:!no-underline
                 text-text text-[.7rem] tracking-[.06em]"
          role="button"
          type="button"
          (click)="closeModal()"
        >
          <span class="material-symbols-outlined text-[.9rem]">arrow_back</span>
          Annuler
        </button>
        <button
          class="!mt-0 !mx-0 !bg-primary hover:!bg-primary-400 text-white text-[.72rem] tracking-[.08em] uppercase"
          role="button"
          title="Enregistrer la fiche"
          type="submit"
        >
          {{ fiche() ? "Mettre à jour" : "Créer la fiche" }}
          <span class="material-symbols-outlined text-[.9rem]">check</span>
        </button>
      </div>

      @if (ficheService.errorUpdate()) {
        <app-error [errorMessage]="ficheService.errorUpdate() ?? ''" />
      }

    </form>
  </div>
</section>
