@if (occurrence(); as o) {
  <article class="p-4 min-w-[280px] max-w-[90vw]" [class.blur-2xl]="sharedService.blurBackground()">
    <header class="flex items-center justify-between gap-4 mb-2">
      <h3 class="m-0 text-lg">Occurrence #{{ o.id }}</h3>
      <button
        aria-label="Fermer"
        class="bg-transparent border-0 text-xl"
        type="button"
        (click)="onClose()()"
      >
        ×
      </button>
    </header>

    <section class="space-y-1">
      @if (o.taxon?.scientific_name) {
        <p>Nom scientifique: {{ o.taxon!.scientific_name }}</p>
      }
      @if (o.taxon?.taxon_repository) {
        <p>Référentiel: {{ o.taxon!.taxon_repository }}</p>
      }
      @if (o.taxon?.vernacular_names?.length) {
        <p>Noms vernaculaires: {{ o.taxon!.vernacular_names!.join(', ') }}</p>
      }

      <div class="w-40 h-40 relative">
        <img
          fill
          priority
          [alt]="imageAlt()"
          [ngSrc]="imageSrc()"
          [title]="imageTitle()"
        />
      </div>

      @if (o.anecdotes) {
        <p>{{ o.anecdotes }}</p>
      }

      @if (sharedService.canEditTrail(
        userService.user(),
        sentier(),
        userService.isUserAdmin()
      )) {
        <div>
          <button class="" role="button" title="modifier l'individu" type="button" (click)="openOccurrenceForm()">
            Modifier
          </button>
          <button class="bg-red-800 hover:bg-red-600 text-white" role="button" title="supprimer l'individu" type="button" (click)="openDeleteConfirmation()">
            Supprimer
          </button>
        </div>
      }

      <hr class="mt-3 mb-0"/>
      <h3 class="mb-0 pb-0">Fiche</h3>
      @if (o.card_tag){
        <div class="flex gap-2">
          @if (userService.isLoggedIn()){
            <button class="bg-background ml-0" role="button" title="Éditer la fiche" type="button" (click)="editFicheModal()">
              <span class="material-symbols-outlined ">edit_document</span> <span>Éditer la fiche</span>
            </button>
          }
        </div>
        <div class="flex gap-2">
          <button class="bg-background ml-0" role="button" title="Voir la fiche" type="button">
            <a class="mt-2" target="_blank" [routerLink]="['/fiche', o.taxon!.taxon_repository, o.taxon!.taxonomic_id, o.taxon!.name_id]">
              <span class="material-symbols-outlined">article</span>
            </a>
          </button>

          <app-qr-code-button [taxon]="o.taxon!"/>

          <app-pdf-export
            [fiche]="fiche()"
            [imageUrl]="getFirstImageUrl()"
            [taxon]="o.taxon!"
          />
        </div>
      } @else {
        <p>Pas de fiche</p>
        @if (userService.isLoggedIn()){
          <button class="bg-background" role="button" title="Créer la fiche" type="button" (click)="createFicheModal()">
            <span class="material-symbols-outlined ">note_add</span>
          </button>
        }
      }
    </section>
  </article>

  @if (showOccurrenceForm) {
    <app-occurrence-form
      [occurrence]="occurrence()"
      [position]="o.position!"
      [sentier]="o.sentier!"
      (modalClosed)="closeOccurrenceForm()"
      (modalSuccessed)="occurrenceUpdateSuccessed()"
    />
  }

  @if (showDeleteConfirmModal) {
    <app-modal-delete-trail-confirmation
      [occurrenceToDelete]="occurrence()"
      [type]="'occurrence'"
      (modalClosed)="closeDeleteConfirmModal()"
      (modalSucceed)="deleteOccurrence()"
    />
  }

  @if (showFicheModal()) {
    <app-fiche-form
      [fiche]="fiche() ?? null"
      [referentiel]="o.taxon!.taxon_repository"
      [taxonomic_id]="o.taxon!.taxonomic_id!"
      (ficheCreated)="ficheCreationSuccess()"
      (modalClosed)="closeFicheModal()"
    />
  }
}
