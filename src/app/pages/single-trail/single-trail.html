<section [class.blur-2xl]="sharedService.blurBackground()">
  @if (sentierService.loading()) {
    <app-loader />
  } @else if (sentierService.error()) {
    <app-error [errorMessage]="sentierService.error() ?? 'Erreur inconnue'" />
  } @else {
    <!-- HEADER -->
    <section class="px-4 pt-6 pb-2 flex flex-col gap-1">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <h2 class="!m-0 !p-0 text-2xl font-bold text-text">{{ sentier!.display_name }}</h2>

        @if (sentier!.status !== 'ValidÃ©') {
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold
            bg-primary-100 text-secondary border border-primary-200">
            {{ sentier!.status ?? 'Brouillon' }}
          </span>
        } @else {
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold
            bg-accent-100 text-accent border border-accent-200">
            ValidÃ©
          </span>
        }
      </div>

      <!-- MÃ©tadonnÃ©es compactes -->
      <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-text-500 mt-1">
        <span>CrÃ©Ã© le <span class="text-text font-medium">{{ sentier!.date_creation | date:"d MMM y" }}</span></span>
        @if (sentier!.date_modification) {
          <span>Â· ModifiÃ© le <span class="text-text font-medium">{{ sentier!.date_modification | date:"d MMM y" }}</span></span>
        }
        @if (sentier!.date_publication) {
          <span>Â· PubliÃ© le <span class="text-text font-medium">{{ sentier!.date_publication | date:"d MMM y" }}</span></span>
        }
        <span>Â· Par <span class="text-text font-medium">{{ sentier!.author }}</span></span>
        @if (userService.isUserAdmin()) {
          <span class="text-text-400">Â· ID {{ sentier!.author_id }} Â· {{ sentier!.author_email }}</span>
        }
      </div>
    </section>

    <!-- ACTIONS (owner ou admin) -->
    @if (sentier!.status !== 'ValidÃ©' && isLoggedIn() && user && user.id === sentier!.author_id) {
      <section class="mx-4 mt-4 p-4 rounded-xl bg-background-50 border border-background-200 flex flex-wrap gap-2">
        <button class="mt-0 mx-0" role="button" title="Modifier le sentier" type="button" (click)="openTrailModal(sentier!)">
          âœï¸ Modifier
        </button>

        @if (sentier!.status !== 'ValidÃ©' && sentier!.status !== 'En attente') {
          <button class="mt-0 mx-0 bg-accent hover:bg-accent-600 text-white" role="button" title="VÃ©rifier le sentier" type="button" (click)="checkSentier(sentier!)">
            ğŸ” VÃ©rifier
          </button>
        }

        @if (sentierCheck().status && !sentierCheckError() && sentier!.status !== 'En attente') {
          <button class="mt-0 mx-0 bg-accent hover:bg-accent-700 text-white" role="button" title="Envoyer en validation" type="button" (click)="sendTrailToReview(sentier!)">
            ğŸš€ Envoyer en validation
          </button>
        }

        <button
          class="mt-0 mx-0 bg-red-700 hover:bg-red-600 text-white border-red-700"
          role="button"
          title="Supprimer le sentier"
          type="button"
          (click)="openDeleteConfirmModal(sentier!)"
        >
          ğŸ—‘ï¸ Supprimer
        </button>
      </section>
    }

    @if (sentier!.status !== 'ValidÃ©' && !(isLoggedIn() && user && user.id === sentier!.author_id)) {
      <p class="mx-4 mt-3 text-text-400 text-xs italic">Connectez-vous pour modifier ce sentier.</p>
    }

    <!-- FEEDBACK VALIDATION -->
    @if (sentierCheck().status && sentier!.status !== 'En attente') {
      <section class="mx-4 mt-3">
        <app-sentier-check-errors [check]="sentierCheck()!" />
      </section>
    }
    @if (sentierCheckError() && sentier!.status !== 'En attente') {
      <section class="mx-4 mt-3 p-4 rounded-xl border-2 border-primary bg-primary-50">
        <h5 class="m-0 p-0 text-sm font-semibold text-secondary mb-2">âš ï¸ Erreurs dÃ©tectÃ©es</h5>
        <app-sentier-check-errors [error]="sentierCheckError()!" />
        <p class="mt-2 text-xs text-secondary font-medium">RÃ©solvez les erreurs ci-dessus pour pouvoir soumettre ce sentier.</p>
      </section>
    }

    <!-- ADMIN SECTION -->
    @if (userService.isUserAdmin() && sentier!.status === 'En attente') {
      <section class="mx-4 mt-4 p-4 rounded-xl bg-accent-50 border border-accent-200">
        <h3 class="m-0 p-0 ml-0 text-base font-bold text-accent mb-3">ğŸ” Options administrateur</h3>
        <div class="flex flex-wrap gap-2 mt-2">
          <button class="mt-0 mx-0" role="button" title="VÃ©rifier le sentier" type="button" (click)="checkSentier(sentier!)">VÃ©rifier</button>
          <button class="mt-0 mx-0 bg-accent hover:bg-accent-700 text-white" role="button" title="Publier le sentier" type="button">âœ… Publier</button>
          <button class="mt-0 mx-0 bg-red-700 hover:bg-red-600 text-white border-red-700" role="button" title="Refuser le sentier" type="button">âŒ Refuser</button>
        </div>
        <app-sentier-check-errors [check]="sentierCheck()!" />
        @if (sentierCheckError()) {
          <div class="mt-3">
            <app-sentier-check-errors [error]="sentierCheckError()!" />
          </div>
        }
      </section>
    }

    <!-- EXPORT PDF + QR -->
    <section class="mx-4 mt-4 p-4 rounded-xl bg-white/60 border border-background-200 flex flex-wrap items-center justify-between gap-4">
      <app-pdf-export
        type="sentier"
        [isLoading]="taxonSearchService.loading()"
        [mapImageUrl]="mapImageUrl()"
        [sentier]="sentier!"
        [taxons]="taxonSearchService.taxons()"
        (beforeExport)="captureMap()"
      />
      <img
        alt="QR code du sentier"
        class="rounded-lg"
        height="80"
        priority
        width="80"
        [ngSrc]="trailQrCode()"
      />
    </section>

    <!-- CARTE (Ã©lÃ©ment mis en avant) -->
    <section class="mx-4 mt-4 rounded-xl overflow-hidden shadow-lg border border-background-200">
      <app-map #mapComponent [singleSentier]="sentier" />
    </section>

    <!-- STATS RAPIDES + IMAGE + QR -->
    <section class="mx-4 mt-4 grid grid-cols-2 gap-3 sm:grid-cols-4">
      <div class="col-span-2 sm:col-span-2 p-4 rounded-xl bg-white/60 border border-background-200 flex flex-col gap-3">
        @if (sentier!.image) {
          <div class="w-full aspect-video relative rounded-lg overflow-hidden">
            <img
              class="object-cover"
              fill
              priority
              [alt]="'Image du sentier ' + sentier!.display_name"
              [ngSrc]="sentier!.image.url!"
            />
          </div>
        } @else {
          <div class="w-full aspect-video rounded-lg bg-background-200 flex items-center justify-center text-text-400 text-sm">
            Aucune image
          </div>
        }
      </div>

      <!-- Stats -->
      <div class="p-4 rounded-xl bg-white/60 border border-background-200 flex flex-col items-center justify-center text-center gap-1">
        <span class="text-2xl font-bold text-primary">{{ sentier!.path_length }}</span>
        <span class="text-xs text-text-500">mÃ¨tres</span>
      </div>

      <div class="p-4 rounded-xl bg-white/60 border border-background-200 flex flex-col items-center justify-center text-center gap-1">
        <span class="text-2xl font-bold text-secondary">{{ sentier!.occurrences_count }}</span>
        <span class="text-xs text-text-500">observations</span>
      </div>

      <div class="p-4 rounded-xl bg-white/60 border border-background-200 flex flex-col items-center justify-center text-center gap-1">
        <span class="text-2xl font-bold text-accent">{{ sentier!.nb_taxons }}</span>
        <span class="text-xs text-text-500">taxons</span>
      </div>

      <!-- PMR -->
      <div class="p-4 rounded-xl bg-white/60 border border-background-200 flex flex-col items-center justify-center text-center gap-1">
        <span class="text-lg">â™¿</span>
        <span class="text-xs text-text-500 font-medium">{{ pdfExportService.getPmrText(sentier!.prm) }}</span>
      </div>
    </section>

    <!-- SAISONS -->
    @if (sentier!.best_season) {
      <section class="mx-4 mt-4 p-4 rounded-xl bg-white/60 border border-background-200">
        <h4 class="m-0 p-0 text-sm font-semibold text-text-600 mb-3">ğŸŒ¿ Meilleures saisons</h4>
        <div class="flex flex-wrap gap-4">
          @for (season of sentier!.best_season; track $index) {
            @if (season) {
              <div class="flex flex-col items-center gap-1">
                <img
                  class="rounded-lg"
                  height="48"
                  width="48"
                  [alt]="seasonLabels[$index]"
                  [ngSrc]="'/assets/images/' + seasonImages[$index]"
                  [title]="seasonLabels[$index]"
                />
                <span class="text-xs text-text-500">{{ seasonLabels[$index] }}</span>
              </div>
            }
          }
        </div>
      </section>
    }

    <!-- ALERTES CHEMIN/POSITION -->
    @if (!sentier!.position || !sentier!.position.start || !sentier!.path || sentier!.path.coordinates.length === 0) {
      <section class="mx-4 mt-4 p-3 rounded-xl bg-primary-50 border border-primary-200 text-xs text-secondary flex flex-col gap-1">
        @if (!sentier!.position || !sentier!.position.start) {
          <span>âš ï¸ Aucune position de dÃ©part/arrivÃ©e dÃ©finie</span>
        }
        @if (!sentier!.path || sentier!.path.coordinates.length === 0) {
          <span>âš ï¸ Aucun chemin dÃ©fini</span>
        }
      </section>
    }

    <!-- TAXONS -->
    <section class="mx-4 mt-4 mb-8">
      <h3 class="ml-0 text-base font-bold text-text mb-3">ğŸŒ± Taxons du sentier</h3>
      <ul class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
        @for (occurrence of occurencesUniques(); track occurrence.id) {
          <app-occurrence-card
            [occurrence]="occurrence"
            (openOccurrence)="openOccurrence($event)"
          />
        }
      </ul>
    </section>

  }
</section>

<!-- MODALS -->
@if (showTrailModal) {
  <app-sentier-form
    [sentier]="sentierToUpdate"
    (modalClosed)="closeTrailModal()"
  />
}

@if (showDeleteConfirmModal) {
  <app-modal-delete-trail-confirmation
    [sentierToDelete]="sentierToDelete"
    (modalClosed)="closeDeleteConfirmModal()"
  />
}

<dialog
  #occurrenceListDialog
  class="border-0 rounded-xl p-0 shadow-2xl top-1/2 left-1/2 -translate-y-1/2 -translate-x-1/2 w-full max-w-2xl"
  (close)="closeOccurrence()"
>
  <app-occurrence-modal-detail
    [occurrence]="selectedOccurrence()"
    [onClose]="closeOccurrence"
    [sentier]="sentier!"
  />
</dialog>
