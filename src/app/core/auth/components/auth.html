<div id="login">
  @if (!userService.isLoggedIn()) {
    <button
      class="!mt-0 !mx-0 !shadow-none !bg-transparent !border !border-background-300
             hover:!bg-background-100 hover:!border-background-400 hover:!no-underline
             text-text text-[.72rem] tracking-[.08em] uppercase"
      role="button"
      tabindex="0"
      title="Se connecter"
      type="button"
      (click)="openLoginPopup()"
      (keydown.enter)="openLoginPopup()"
      (keydown.space)="openLoginPopup()"
    >
      <span class="material-symbols-outlined text-[.9rem]">login</span>
      <span class="hidden xs:inline">Connexion</span>
    </button>
  } @else {
    <div class="flex items-center gap-2">
      <span class="hidden sm:inline text-xs text-text-500">
        {{ userService.user()?.name }}
      </span>
      <button
        class="!mt-0 !mx-0 !shadow-none !bg-transparent !border !border-background-300
               hover:!bg-background-100 hover:!border-background-400 hover:!no-underline
               text-text text-[.72rem] tracking-[.08em] uppercase"
        role="button"
        tabindex="0"
        type="button"
        (click)="logout()"
        (keydown.enter)="logout()"
        (keydown.space)="logout()"
      >
        <span class="material-symbols-outlined text-[.9rem]">logout</span>
        <span class="hidden xs:inline">Déconnecter</span>
      </button>
    </div>
  }

  <!-- Login modal -->
  @if (loginPopup()) {
    <div class="fixed inset-0 z-40 flex items-center justify-center p-4 bg-background/80 backdrop-blur-sm">

      <!-- Decorative lines -->
      <div aria-hidden="true" class="fixed inset-0 pointer-events-none flex justify-evenly">
        <span class="w-px h-full bg-gradient-to-b from-transparent via-primary/20 to-transparent"></span>
        <span class="w-px h-full bg-gradient-to-b from-transparent via-primary/20 to-transparent"></span>
        <span class="w-px h-full bg-gradient-to-b from-transparent via-primary/20 to-transparent"></span>
      </div>

      <!-- Panel -->
      <div class="relative z-10 w-full max-w-sm bg-background-50 rounded-xl shadow-2xl overflow-hidden">

        <!-- Header -->
        <header class="relative px-8 pt-8 pb-5">
          <p class="text-[.68rem] tracking-[.18em] uppercase text-text-500 mb-2">Bienvenue</p>
          <h3 class="!m-0 !p-0 text-2xl font-semibold tracking-tight text-text">Connexion</h3>
          <button
            class="absolute top-4 right-4 !mt-0 !mx-0 !shadow-none !bg-transparent !border-0 !p-1
                   grid place-items-center w-9 h-9 rounded-full text-text-400 hover:text-text hover:bg-background-200"
            role="button"
            tabindex="0"
            title="Fermer"
            type="button"
            (click)="closeLoginPopup()"
            (keydown)="handleKey($event)"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </header>

        <!-- Barre colorée -->
        <div class="h-[3px] bg-gradient-to-r from-primary to-primary-300"></div>

        <!-- Form -->
        <form
          #f="ngForm"
          class="flex flex-col gap-4 px-8 py-7"
          [formGroup]="loginForm"
          (ngSubmit)="f.form.valid && onSubmit()"
        >

          <!-- Username -->
          <div class="flex flex-col gap-1.5">
            <label class="text-[.68rem] tracking-[.06em] uppercase text-text-500" for="username">
              Email ou nom d'utilisateur
            </label>
            <div class="relative">
              <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[1rem] text-text-300 pointer-events-none">
                alternate_email
              </span>
              <input
                class="w-full !bg-white pl-9 pr-4 py-2.5 text-sm text-text border-[1.5px] border-background-200
                       rounded-lg placeholder:text-text-300 placeholder:italic transition
                       focus:outline-none focus:border-accent focus:ring-[3px] focus:ring-accent/15"
                formControlName="username"
                id="username"
                name="username"
                placeholder="email ou nom d'utilisateur"
                type="text"
              />
            </div>
            @if (!loginForm.get('username')?.valid && f.submitted) {
              <app-error errorMessage="Le nom d'utilisateur ou l'email est obligatoire !" />
            }
          </div>

          <!-- Password -->
          <div class="flex flex-col gap-1.5">
            <label class="text-[.68rem] tracking-[.06em] uppercase text-text-500" for="password">
              Mot de passe
            </label>
            <div class="relative">
              <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[1rem] text-text-300 pointer-events-none">
                key
              </span>
              <input
                class="w-full !bg-white pl-9 pr-10 py-2.5 text-sm text-text border-[1.5px] border-background-200
                       rounded-lg placeholder:text-text-300 placeholder:italic transition
                       focus:outline-none focus:border-accent focus:ring-[3px] focus:ring-accent/15"
                formControlName="password"
                id="password"
                placeholder="Mot de passe"
                [type]="passwordFieldType"
              />
              <span
                class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-[1rem] text-text-400 cursor-pointer hover:text-text transition"
                role="button"
                tabindex="0"
                title="Afficher/Masquer le mot de passe"
                (click)="togglePasswordVisibility()"
                (keydown.enter)="togglePasswordVisibility()"
                (keydown.space)="togglePasswordVisibility()"
              >
                {{ passwordFieldIcon }}
              </span>
            </div>
            @if (!loginForm.get('password')?.valid && f.submitted) {
              <app-error errorMessage="Un mot de passe est obligatoire !" />
            }
          </div>

          <!-- Submit -->
          <div class="flex flex-col gap-2 pt-2 border-t border-background-200">
            <button
              class="!mt-0 !mx-0 w-full !bg-primary hover:!bg-primary-400 text-white text-[.72rem] tracking-[.08em] uppercase"
              role="button"
              title="Se connecter"
              type="submit"
            >
              <span class="material-symbols-outlined text-[.9rem]">login</span>
              Se connecter
            </button>
            @if (error()) {
              <app-error [errorMessage]="error()" />
            }
          </div>

        </form>

        <!-- Inscription -->
        <div class="flex items-center justify-between gap-3 px-8 pb-7 pt-0 border-t border-background-200 pt-5">
          <span class="text-xs text-text-500">Pas encore de compte ?</span>
          <a
          class="inline-flex items-center gap-1.5 px-4 py-2 rounded-lg border border-background-300
          bg-transparent text-text text-[.7rem] tracking-[.06em] hover:bg-background-100
          hover:border-accent hover:text-accent transition-colors no-underline !h-auto !shadow-none"
          target="_blank"
          [href]="inscriptionUrl"
          >
          <span class="material-symbols-outlined text-[.9rem]">person_add</span>
          S'inscrire
          </a>
        </div>

      </div>
    </div>
  }
</div>
