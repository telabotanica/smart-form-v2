<div class="w-full">
  <div class="flex items-center gap-3 my-2">
    <button class="px-3 py-1.5 border border-gray-200 rounded-md bg-white"
            type="button"
            (click)="locateMe()">Ma position</button>
  </div>

  <div class="relative w-full h-[420px]">
    @if (currentSentier(); as s) {
      @if ((s.path?.coordinates?.length || 0) > 0) {
        <app-waypoint-list
          [points]="s.path!.coordinates!"
          (remove)="removeWaypoint($event)"
          (reorder)="onReorder($event)"
        />
      }
    }

    @if (singleSentierService.loading() || singleSentierService.loadingUpdate() || sentierService.loading()) {
      <app-loader />
    } @else {
      <div #mapContainer aria-label="Carte des sentiers" class="w-full h-full" role="region"></div>
    }
  </div>

     <app-error [errorMessage]="occurrenceService.error() ?? ''" />
     <app-error [errorMessage]="singleSentierService.errorUpdate() ?? ''" />

</div>

 <dialog #detailsDialog class="border-0 rounded-xl p-0 shadow-2xl" (close)="closeDetails()">
   @if (selectedSentier(); as s) {
    <article class="p-4 min-w-[280px] max-w-[90vw]">
      <header class="flex items-center justify-between gap-4 mb-2">
        <h3 class="m-0 text-lg">{{ s.display_name || s.name || ('Sentier #' + s.id) }}</h3>
        <button aria-label="Fermer" class="bg-transparent border-0 text-xl" type="button" (click)="closeDetails()">Ã—</button>
      </header>
      <section class="space-y-1">
        @if (s.author) { <p>Auteur: {{ s.author }}</p> }
        @if (s.details) { <p>{{ s.details }}</p> }
        @if (s.occurrences_count) { <p>{{ s.occurrences_count }} observations</p> }
        @if (s.path_length) { <p>{{ s.path_length }} m</p> }
      </section>
      <footer class="mt-3">
        <a class="text-sky-700 underline" [routerLink]="['/trail', s.id]">Ouvrir le sentier</a>
      </footer>
    </article>
  }
</dialog>

<dialog
  #occurrenceDialog
  class="border-0 rounded-xl p-0 shadow-2xl"
  (close)="closeOccurrence()"
>
  <app-occurrence-modal-detail
    [occurrence]="selectedOccurrence()"
    [onClose]="closeOccurrence"
    [sentier]="singleSentier()!"
  />
</dialog>

@if (showOccurrenceForm()) {
  <app-occurrence-form
    [position]="occurrenceFormPosition()!"
    [sentier]="singleSentier()!"
    (modalClosed)="closeOccurrenceModal()"
    (modalSuccessed)="occurrenceModalSuccessed()"
  />
}
