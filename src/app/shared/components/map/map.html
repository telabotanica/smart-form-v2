<div class="w-full relative">


  <div class="relative w-full h-[420px]">
    @if (currentSentier(); as s) {
      @if ((s.path?.coordinates?.length || 0) > 0) {
        <app-waypoint-list
          [points]="s.path!.coordinates!"
          (remove)="removeWaypoint($event)"
          (reorder)="onReorder($event)"
        />
      }
    }

    @if (singleSentierService.loading() || singleSentierService.loadingUpdate() || sentierService.loading()) {
      <app-loader />
    } @else {
      <div #mapContainer aria-label="Carte des sentiers" class="w-full h-full" role="region"></div>
    }
  </div>

  <div class="flex items-center gap-3 my-2 absolute bottom-0 left-20 transform -translate-x-1/2 z-20">
    <button class="px-3 mt-0 border border-gray-200 rounded-md bg-white"
            type="button"
            (click)="locateMe()">Ma position</button>
  </div>

  <app-error [errorMessage]="occurrenceService.error() ?? ''" />
  <app-error [errorMessage]="singleSentierService.errorUpdate() ?? ''" />
</div>

<dialog
  #detailsDialog
  class="border-0 rounded-xl p-0 shadow-2xl top-20 left-1/2 translate-y--50 -translate-x-1/2 w-full max-w-2xl"
  (close)="closeDetails()"
>
  @if (selectedSentier(); as s) {
    <article class="flex flex-col w-full min-w-72">

      <!-- Header -->
      <header class="relative px-8 pt-8 pb-5">
        <p class="text-[.68rem] tracking-[.18em] uppercase text-text-500 mb-2">Sentier</p>
        <h3 class="!m-0 !p-0 text-2xl font-semibold tracking-tight text-text">
          {{ s.display_name || s.name || ('Sentier #' + s.id) }}
        </h3>
        <button
          aria-label="Fermer"
          class="absolute top-4 right-4 !mt-0 !mx-0 !shadow-none !bg-transparent !border-0 !p-1
                 grid place-items-center w-9 h-9 rounded-full text-text-400 hover:text-text hover:bg-background-200"
          type="button"
          (click)="closeDetails()"
        >
          <span class="material-symbols-outlined">close</span>
        </button>
      </header>

      <!-- Barre colorée -->
      <div class="h-[3px] bg-gradient-to-r from-primary to-primary-300 shrink-0"></div>

      <!-- Corps -->
      <section class="flex flex-col gap-3 px-8 py-7">

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-2">
          @if (s.occurrences_count) {
            <div class="flex flex-col items-center justify-center p-3 rounded-lg bg-background-100 border border-background-200 text-center">
              <span class="text-xl font-bold text-primary">{{ s.occurrences_count }}</span>
              <span class="text-xs text-text-500">observations</span>
            </div>
          }
          @if (s.path_length) {
            <div class="flex flex-col items-center justify-center p-3 rounded-lg bg-background-100 border border-background-200 text-center">
              <span class="text-xl font-bold text-accent">{{ s.path_length }}</span>
              <span class="text-xs text-text-500">mètres</span>
            </div>
          }
        </div>

        @if (s.author) {
          <p class="!m-0 text-xs text-text-500">
            Par <span class="text-text font-medium">{{ s.author }}</span>
          </p>
        }

        @if (s.details) {
          <p class="!m-0 text-sm text-text italic px-4 py-3 rounded-lg bg-background-100 border border-background-200">
            {{ s.details }}
          </p>
        }
      </section>

      <!-- Footer -->
      <footer class="flex items-center gap-2 px-8 pb-7 pt-0 border-t border-background-200 pt-4">

        <a class="inline-flex items-center gap-1.5 px-4 py-2 rounded-lg
        bg-primary hover:bg-primary-400 text-white text-[.7rem] tracking-[.06em]
        transition-colors no-underline"
        [routerLink]="['/trail', s.id]"
        >
        <span class="material-symbols-outlined text-[.9rem]">hiking</span>
        Ouvrir le sentier
        </a>
        <app-qr-code-button [sentier]="s" />
      </footer>

    </article>
  }
</dialog>

<dialog
  #occurrenceDialog
  class="border-0 rounded-xl p-0 shadow-2xl top-20 left-1/2 translate-y--50 -translate-x-1/2 w-full max-w-2xl"
  (close)="closeOccurrence()"
>
  <app-occurrence-modal-detail
    [occurrence]="selectedOccurrence()"
    [onClose]="closeOccurrence"
    [sentier]="singleSentier()!"
  />
</dialog>

@if (showOccurrenceForm()) {
  <app-occurrence-form
    [position]="occurrenceFormPosition()!"
    [sentier]="singleSentier()!"
    (modalClosed)="closeOccurrenceModal()"
    (modalSuccessed)="occurrenceModalSuccessed()"
  />
}
